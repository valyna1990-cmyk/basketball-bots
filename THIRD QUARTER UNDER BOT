#!/usr/bin/env python3
# /opt/basketball-bots/bots/third_quarter_under_bot.py

import asyncio
import logging
import sys
import os
import json
from datetime import datetime, timedelta
from typing import Dict, List, Optional
import aiohttp
import pandas as pd
import numpy as np
import psycopg2
from psycopg2.extras import RealDictCursor
import redis

sys.path.append('/opt/basketball-bots')

from config.settings import DATABASE_URL, REDIS_URL, LOG_LEVEL

class ThirdQuarterUnderBot:
    def __init__(self):
        self.bot_name = "Third Quarter Under"
        self.bot_id = "Q3_UNDER_001"
        
        # –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
        self.config = {
            'confidence_threshold': 0.63,
            'max_daily_bets': 4,
            'stake_range': [0.01, 0.035],
            'pace_threshold': 8.0,
            'correlation_threshold': -0.35,  # –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ—Ä–æ–≥
            'target_leagues': ["Greece Basket League", "Euroleague", "Russia VTB", "Spain ACB"],
            'update_interval': 90,  # —Å–µ–∫—É–Ω–¥—ã
            'min_odds': 1.90
        }
        
        self.setup_logging()
        self.db_conn = None
        self.redis_client = None
        
    def setup_logging(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è"""
        log_dir = "/opt/basketball-bots/logs"
        os.makedirs(log_dir, exist_ok=True)
        
        logging.basicConfig(
            level=getattr(logging, LOG_LEVEL),
            format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
            handlers=[
                logging.FileHandler(f"{log_dir}/q3_under_bot.log"),
                logging.StreamHandler(sys.stdout)
            ]
        )
        self.logger = logging.getLogger(self.bot_name)

    async def initialize(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞"""
        try:
            self.logger.info("üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Third Quarter Under Bot...")
            
            self.db_conn = psycopg2.connect(DATABASE_URL)
            self.redis_client = redis.from_url(REDIS_URL)
            
            await self.create_tables()
            
            self.logger.info("‚úÖ Third Quarter Under Bot –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
            return True
            
        except Exception as e:
            self.logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: {e}")
            return False

    async def create_tables(self):
        """–°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –≤ –ë–î"""
        try:
            with self.db_conn.cursor() as cursor:
                cursor.execute("""
                    CREATE TABLE IF NOT EXISTS q3_under_signals (
                        id SERIAL PRIMARY KEY,
                        match_id VARCHAR(100) NOT NULL,
                        home_team VARCHAR(100),
                        away_team VARCHAR(100),
                        league VARCHAR(50),
                        halftime_score VARCHAR(20),
                        first_half_pace FLOAT,
                        pace_deviation FLOAT,
                        quarter_correlation FLOAT,
                        prediction_type VARCHAR(10),
                        confidence FLOAT,
                        predicted_line FLOAT,
                        recommended_stake FLOAT,
                        created_at TIMESTAMP DEFAULT NOW(),
                        status VARCHAR(20) DEFAULT 'active'
                    );

                    CREATE TABLE IF NOT EXISTS q3_under_performance (
                        id SERIAL PRIMARY KEY,
                        signal_id INTEGER REFERENCES q3_under_signals(id),
                        q3_actual_total FLOAT,
                        actual_result VARCHAR(10),
                        profit_loss FLOAT,
                        settled_at TIMESTAMP,
                        created_at TIMESTAMP DEFAULT NOW()
                    );
                """)
                self.db_conn.commit()
                self.logger.info("‚úÖ –¢–∞–±–ª–∏—Ü—ã –ë–î —Å–æ–∑–¥–∞–Ω—ã/–ø—Ä–æ–≤–µ—Ä–µ–Ω—ã")
        except Exception as e:
            self.logger.error(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü: {e}")

    async def fetch_halftime_matches(self) -> List[Dict]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –º–∞—Ç—á–µ–π –Ω–∞ –ø–µ—Ä–µ—Ä—ã–≤–µ"""
        try:
            mock_matches = [
                {
                    'id': 'GREECE_001',
                    'home_team': 'Panathinaikos',
                    'away_team': 'Olympiacos',
                    'league': 'Greece Basket League',
                    'start_time': datetime.now() - timedelta(hours=1),
                    'halftime_score': '58-52',
                    'q1_score': '30-28',
                    'q2_score': '28-24',
                    'current_quarter': 'HALFTIME'
                },
                {
                    'id': 'RUSSIA_001',
                    'home_team': 'CSKA Moscow',
                    'away_team': 'Zenit St Petersburg',
                    'league': 'Russia VTB',
                    'start_time': datetime.now() - timedelta(hours=1),
                    'halftime_score': '62-48',
                    'q1_score': '32-26',
                    'q2_score': '30-22',
                    'current_quarter': 'HALFTIME'
                }
            ]
            
            filtered_matches = [
                match for match in mock_matches 
                if match['league'] in self.config['target_leagues']
                and match.get('halftime_score') is not None
            ]
            
            self.logger.info(f"üìä –ù–∞–π–¥–µ–Ω–æ {len(filtered_matches)} –º–∞—Ç—á–µ–π –Ω–∞ –ø–µ—Ä–µ—Ä—ã–≤–µ")
            return filtered_matches
            
        except Exception as e:
            self.logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –º–∞—Ç—á–µ–π: {e}")
            return []

    async def analyze_game_pace(self, match: Dict) -> Optional[Dict]:
        """–ê–Ω–∞–ª–∏–∑ —Ç–µ–º–ø–∞ –∏–≥—Ä—ã –≤ –ø–µ—Ä–≤–æ–π –ø–æ–ª–æ–≤–∏–Ω–µ"""
        try:
            q1_score = match.get('q1_score', '0-0')
            q2_score = match.get('q2_score', '0-0')
            
            q1_home, q1_away = map(int, q1_score.split('-'))
            q2_home, q2_away = map(int, q2_score.split('-'))
            
            q1_total = q1_home + q1_away
            q2_total = q2_home + q2_away
            
            first_half_pace = q1_total + q2_total
            
            # –ü–æ–ª—É—á–∞–µ–º —Å—Ä–µ–¥–Ω–∏–π —Ç–µ–º–ø –ª–∏–≥–∏
            league_avg_pace = await self.get_league_pace_average(match['league'])
            
            # –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –æ—Ç —Å—Ä–µ–¥–Ω–µ–≥–æ
            pace_deviation = first_half_pace - league_avg_pace
            
            pace_analysis = {
                'first_half_pace': first_half_pace,
                'league_average': league_avg_pace,
                'pace_deviation': pace_deviation,
                'q1_total': q1_total,
                'q2_total': q2_total
            }
            
            return pace_analysis
            
        except Exception as e:
            self.logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ —Ç–µ–º–ø–∞: {e}")
            return None

    async def get_league_pace_average(self, league: str) -> float:
        """–°—Ä–µ–¥–Ω–∏–π —Ç–µ–º–ø –ø–µ—Ä–≤–æ–π –ø–æ–ª–æ–≤–∏–Ω—ã –¥–ª—è –ª–∏–≥–∏"""
        pace_averages = {
            'Greece Basket League': 85.0,
            'Euroleague': 82.5,
            'Russia VTB': 87.2,
            'Spain ACB': 83.8
        }
        return pace_averages.get(league, 85.0)

    async def calculate_quarter_correlation(self, match: Dict, pace_analysis: Dict) -> float:
        """–†–∞—Å—á–µ—Ç –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏ –º–µ–∂–¥—É —á–µ—Ç–≤–µ—Ä—Ç—è–º–∏"""
        try:
            q1_total = pace_analysis['q1_total']
            q2_total = pace_analysis['q2_total']
            
            # –ü—Ä–æ—Å—Ç–∞—è –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–∞–∑–Ω–∏—Ü—ã —Ç–µ–º–ø–æ–≤
            # –í —Ä–µ–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞—Å—å –±—ã –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∞—è –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—è
            if q1_total > 0 and q2_total > 0:
                pace_difference = abs(q1_total - q2_total)
                max_possible_difference = max(q1_total, q2_total)
                
                # –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—è (–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–∞—è –¥–ª—è Under —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏)
                correlation = - (pace_difference / max_possible_difference)
            else:
                correlation = -0.3  # –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                
            return round(correlation, 3)
            
        except Exception as e:
            self.logger.error(f"‚ùå –û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏: {e}")
            return 0.0

    async def calculate_under_confidence(self, match: Dict, pace_analysis: Dict, correlation: float) -> float:
        """–†–∞—Å—á–µ—Ç —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –¥–ª—è Under —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏"""
        try:
            base_confidence = 0.65
            
            # –§–∞–∫—Ç–æ—Ä —Ç–µ–º–ø–∞ (—á–µ–º –≤—ã—à–µ —Ç–µ–º–ø, —Ç–µ–º –≤—ã—à–µ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤ –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏)
            pace_factor = min(pace_analysis['pace_deviation'] / 20.0, 1.0)
            
            # –§–∞–∫—Ç–æ—Ä –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏
            correlation_factor = abs(correlation) * 2.0  # –£—Å–∏–ª–∏–≤–∞–µ–º –≤–ª–∏—è–Ω–∏–µ –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏
            
            # –§–∞–∫—Ç–æ—Ä –ª–∏–≥–∏
            league_factor = await self.get_league_under_strength(match['league'])
            
            # –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å
            under_confidence = (
                base_confidence * 0.3 +
                pace_factor * 0.3 +
                correlation_factor * 0.3 +
                league_factor * 0.1
            )
            
            return min(under_confidence, 0.9)  # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª—è Under —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
            
        except Exception as e:
            self.logger.error(f"‚ùå –û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏: {e}")
            return 0.0

    async def get_league_under_strength(self, league: str) -> float:
        """–°–∏–ª–∞ –ª–∏–≥–∏ –¥–ª—è Under —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏"""
        under_strength = {
            'Greece Basket League': 0.8,   # –û–±–æ—Ä–æ–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Å—Ç–∏–ª—å
            'Euroleague': 0.7,
            'Russia VTB': 0.6,
            'Spain ACB': 0.75
        }
        return under_strength.get(league, 0.5)

    async def generate_prediction(self, match: Dict) -> Optional[Dict]:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è Under"""
        try:
            # –ê–Ω–∞–ª–∏–∑ —Ç–µ–º–ø–∞
            pace_analysis = await self.analyze_game_pace(match)
            if not pace_analysis:
                return None
                
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ª–æ–≤–∏—è –≤—ã—Å–æ–∫–æ–≥–æ —Ç–µ–º–ø–∞
            if pace_analysis['pace_deviation'] < self.config['pace_threshold']:
                return None
                
            # –†–∞—Å—á–µ—Ç –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏
            correlation = await self.calculate_quarter_correlation(match, pace_analysis)
            
            if correlation >= self.config['correlation_threshold']:  # –£—Å–ª–æ–≤–∏–µ –¥–ª—è Under
                return None
                
            # –†–∞—Å—á–µ—Ç —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏
            confidence = await self.calculate_under_confidence(match, pace_analysis, correlation)
            
            if confidence >= self.config['confidence_threshold']:
                # –ü—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º –ª–∏–Ω–∏—é –¥–ª—è Under
                league_avg_q3 = await self.get_league_q3_average(match['league'])
                predicted_line = league_avg_q3 + 2.0  # –ö–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω–∞—è –ª–∏–Ω–∏—è
                
                prediction = {
                    'match_id': match['id'],
                    'prediction_type': 'UNDER',
                    'confidence': round(confidence, 3),
                    'pace_deviation': round(pace_analysis['pace_deviation'], 1),
                    'quarter_correlation': correlation,
                    'predicted_line': round(predicted_line, 1),
                    'time_window': 'Q3 Start - Q3 5:00',
                    'expected_value': round(confidence * 1.1, 3)  # –í—ã—Å–æ–∫–∏–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã
                }
                return prediction
                
            return None
            
        except Exception as e:
            self.logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è: {e}")
            return None

    async def get_league_q3_average(self, league: str) -> float:
        """–°—Ä–µ–¥–Ω–∏–π —Ç–æ—Ç–∞–ª —Ç—Ä–µ—Ç—å–µ–π —á–µ—Ç–≤–µ—Ä—Ç–∏ –¥–ª—è –ª–∏–≥–∏"""
        q3_averages = {
            'Greece Basket League': 42.5,
            'Euroleague': 41.8,
            'Russia VTB': 43.2,
            'Spain ACB': 42.0
        }
        return q3_averages.get(league, 42.5)

    async def calculate_under_stake(self, confidence: float) -> float:
        """–†–∞—Å—á–µ—Ç —Å—Ç–∞–≤–∫–∏ –¥–ª—è Under —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏"""
        base_stake = 0.015  # –ú–µ–Ω—å—à–µ –±–∞–∑–æ–≤—ã–π —Ä–∞–∑–º–µ—Ä –¥–ª—è Under
        
        # Under —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –±–æ–ª–µ–µ —Ä–∏—Å–∫–æ–≤–∞–Ω–Ω–∞—è, –ø–æ—ç—Ç–æ–º—É –º–µ–Ω—å—à–∏–π –º–Ω–æ–∂–∏—Ç–µ–ª—å
        confidence_multiplier = confidence / 0.7 * 0.8
        
        stake = base_stake * confidence_multiplier
        stake = max(self.config['stake_range'][0], 
                   min(stake, self.config['stake_range'][1]))
        
        return round(stake, 4)

    async def save_signal(self, match: Dict, prediction: Dict, stake: float):
        """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–∞ –≤ –ë–î"""
        try:
            with self.db_conn.cursor() as cursor:
                cursor.execute("""
                    INSERT INTO q3_under_signals 
                    (match_id, home_team, away_team, league, halftime_score,
                     first_half_pace, pace_deviation, quarter_correlation,
                     prediction_type, confidence, predicted_line, recommended_stake)
                    VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s)
                """, (
                    match['id'],
                    match['home_team'],
                    match['away_team'],
                    match['league'],
                    match['halftime_score'],
                    prediction['pace_deviation'] + await self.get_league_pace_average(match['league']),
                    prediction['pace_deviation'],
                    prediction['quarter_correlation'],
                    prediction['prediction_type'],
                    prediction['confidence'],
                    prediction['predicted_line'],
                    stake
                ))
                self.db_conn.commit()
                
            self.logger.info(f"üíæ –°–∏–≥–Ω–∞–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω –¥–ª—è {match['home_team']} vs {match['away_team']}")
            
        except Exception as e:
            self.logger.error(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–∏–≥–Ω–∞–ª–∞: {e}")

    async def send_telegram_alert(self, match: Dict, prediction: Dict, stake: float):
        """–û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram"""
        try:
            message = f"""
üõ°Ô∏è *THIRD QUARTER UNDER SIGNAL*

üèÄ *–ú–∞—Ç—á:* {match['home_team']} vs {match['away_team']}
üìä *–õ–∏–≥–∞:* {match['league']}
‚ö° *–¢–µ–º–ø 1-–π –ø–æ–ª–æ–≤–∏–Ω—ã:* +{prediction['pace_deviation']} –æ—Ç —Å—Ä–µ–¥–Ω–µ–≥–æ
üîÑ *–ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è:* {prediction['quarter_correlation']}
üéØ *–ü—Ä–æ–≥–Ω–æ–∑:* UNDER {prediction['predicted_line']} –≤ 3-–π —á–µ—Ç–≤–µ—Ä—Ç–∏
‚úÖ *–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å:* {prediction['confidence']:.1%}
üí∞ *–°—Ç–∞–≤–∫–∞:* {stake:.1%} –±–∞–Ω–∫—Ä–æ–ª–ª–∞
‚è∞ *–û–∫–Ω–æ:* {prediction['time_window']}

ü§ñ *–ë–æ—Ç:* {self.bot_name}
‚öñÔ∏è *–°—Ç—Ä–∞—Ç–µ–≥–∏—è:* –î–∏–≤–µ—Ä—Å–∏—Ñ–∏–∫–∞—Ü–∏—è
            """
            
            self.logger.info(f"üì§ Telegram alert: {message}")
            
        except Exception as e:
            self.logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram: {e}")

    async def check_daily_limit(self) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–Ω–µ–≤–Ω–æ–≥–æ –ª–∏–º–∏—Ç–∞ —Å—Ç–∞–≤–æ–∫"""
        try:
            today = datetime.now().date()
            with self.db_conn.cursor() as cursor:
                cursor.execute("""
                    SELECT COUNT(*) as bet_count 
                    FROM q3_under_signals 
                    WHERE DATE(created_at) = %s AND status = 'active'
                """, (today,))
                result = cursor.fetchone()
                
            current_bets = result[0] if result else 0
            limit_ok = current_bets < self.config['max_daily_bets']
            
            if not limit_ok:
                self.logger.warning(f"‚ö†Ô∏è –î–æ—Å—Ç–∏–≥–Ω—É—Ç –¥–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç: {current_bets}/{self.config['max_daily_bets']}")
                
            return limit_ok
            
        except Exception as e:
            self.logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–∏–º–∏—Ç–∞: {e}")
            return False

    async def process_matches(self):
        """–û—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ—Ü–µ—Å—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏ –º–∞—Ç—á–µ–π"""
        try:
            if not await self.check_daily_limit():
                return
                
            matches = await self.fetch_halftime_matches()
            
            signals_generated = 0
            for match in matches:
                try:
                    prediction = await self.generate_prediction(match)
                    
                    if prediction:
                        stake = await self.calculate_under_stake(prediction['confidence'])
                        
                        await self.save_signal(match, prediction, stake)
                        await self.send_telegram_alert(match, prediction, stake)
                        
                        signals_generated += 1
                        self.logger.info(f"‚úÖ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω —Å–∏–≥–Ω–∞–ª –¥–ª—è {match['home_team']} vs {match['away_team']}")
                        
                except Exception as e:
                    self.logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –º–∞—Ç—á–∞ {match.get('id')}: {e}")
                    continue
            
            self.logger.info(f"üìà –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ —Å–∏–≥–Ω–∞–ª–æ–≤: {signals_generated}")
            
        except Exception as e:
            self.logger.error(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –º–∞—Ç—á–µ–π: {e}")

    async def run(self):
        """–û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –±–æ—Ç–∞"""
        self.logger.info("üéØ –ó–∞–ø—É—Å–∫ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ Third Quarter Under Bot")
        
        while True:
            try:
                start_time = datetime.now()
                
                await self.process_matches()
                
                execution_time = (datetime.now() - start_time).total_seconds()
                self.logger.debug(f"‚è±Ô∏è –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ü–∏–∫–ª–∞: {execution_time:.2f}—Å")
                
                await asyncio.sleep(self.config['update_interval'])
                
            except KeyboardInterrupt:
                self.logger.info("üõë –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –æ—Å—Ç–∞–Ω–æ–≤–∫–∏")
                break
            except Exception as e:
                self.logger.error(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Ü–∏–∫–ª–µ: {e}")
                await asyncio.sleep(30)

    async def shutdown(self):
        """–ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã"""
        try:
            self.logger.info("üî¥ –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã Third Quarter Under Bot...")
            
            if self.db_conn:
                self.db_conn.close()
                
            self.logger.info("‚úÖ Third Quarter Under Bot –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
            
        except Exception as e:
            self.logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Ä–∞–±–æ—Ç—ã: {e}")

async def main():
    bot = ThirdQuarterUnderBot()
    
    try:
        if not await bot.initialize():
            sys.exit(1)
            
        await bot.run()
        
    except KeyboardInterrupt:
        bot.logger.info("üõë –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã –ø–æ –∑–∞–ø—Ä–æ—Å—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")
    except Exception as e:
        bot.logger.error(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
    finally:
        await bot.shutdown()

if __name__ == "__main__":
    asyncio.run(main())
